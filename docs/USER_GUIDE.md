# TeckoChecker - Complete User Guide

## Table of Contents
1. [Quick Start](#quick-start)
2. [Installation](#installation)
3. [Configuration](#configuration)
4. [Managing Secrets](#managing-secrets)
5. [Managing Polling Jobs](#managing-polling-jobs)
6. [Running Polling Service](#running-polling-service)
7. [REST API](#rest-api)
8. [Troubleshooting](#troubleshooting)

## Quick Start

Get TeckoChecker running in a few simple steps:

```bash
# 1. Create virtual environment
python3 -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate

# 2. Install dependencies
pip install -r requirements.txt

# 3. Initialize database and environment (auto-generates SECRET_KEY)
python scripts/init_db.py --create-env

# 4. Add your API credentials
python teckochecker.py secret add --name "openai-prod" --type openai
python teckochecker.py secret add --name "keboola-prod" --type keboola

# 5. Create a polling job
python teckochecker.py job create \
  --name "My batch job" \
  --batch-id "batch_abc123" \
  --openai-secret "openai-prod" \
  --keboola-secret "keboola-prod" \
  --keboola-stack "https://connection.eu-central-1.keboola.com" \
  --component-id "kds-team.app-custom-python" \
  --config-id "123456" \
  --poll-interval 120

# 6. Start the service (polling starts automatically with the API server)
python teckochecker.py start --daemon
```

For detailed setup instructions and configuration options, see [SETUP.md](SETUP.md).

## Installation

### Requirements
- Python 3.11+
- pip
- SQLite (part of Python)

### Step 1: Clone the repository
```bash
git clone https://github.com/yourusername/teckochecker.git
cd teckochecker
```

### Step 2: Create virtual environment
```bash
python3 -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate
```

### Step 3: Install dependencies
```bash
pip install -r requirements.txt
```

### Step 4: Initialize database and environment
```bash
# Recommended - Automatic setup (creates .env with auto-generated SECRET_KEY)
python scripts/init_db.py --create-env

# Or manual configuration
cp .env.example .env
python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"
# Copy the output and paste it as SECRET_KEY in .env, then:
python scripts/init_db.py
```

**What is SECRET_KEY?**
The `SECRET_KEY` is used to encrypt API keys and tokens in the database using AES-256 encryption (Fernet). This ensures your credentials are stored securely. Never commit your `.env` file or share your `SECRET_KEY`!

### Step 5: Verify setup (optional)
```bash
# Check that everything is configured correctly
python scripts/verify_setup.py
```

## Configuration

### Configuration file .env

The `.env` file is created automatically when you run `python scripts/init_db.py --create-env`. Here's what it contains:

```env
# Database
DATABASE_URL=sqlite:///./teckochecker.db  # Or postgresql://...

# Security - AES-256 encryption key for storing API credentials
SECRET_KEY=your-generated-fernet-key-here  # Auto-generated by --create-env

# Polling
DEFAULT_POLL_INTERVAL=120  # Default interval in seconds
MIN_POLL_INTERVAL=30       # Minimum allowed interval
MAX_POLL_INTERVAL=3600     # Maximum allowed interval (1 hour)
MAX_RETRIES=3              # Number of retries on failure
RETRY_DELAY=60             # Delay between retries

# API Server
API_HOST=0.0.0.0
API_PORT=8000
CORS_ORIGINS=["http://localhost:3000"]  # For future UI

# Logging
LOG_LEVEL=INFO  # DEBUG, INFO, WARNING, ERROR, CRITICAL
LOG_FILE=teckochecker.log
```

### Verify configuration
```bash
python scripts/verify_setup.py
```

## Managing Secrets

Secrets are encrypted API keys stored in the database.

### Add a secret
```bash
# OpenAI API key
python teckochecker.py secret add --name "openai-prod" --type openai
Enter secret value: **********************

# Keboola Storage API token
python teckochecker.py secret add --name "keboola-prod" --type keboola
Enter secret value: **********************
```

### List all secrets
```bash
python teckochecker.py secret list

╭──────────────────────────────────────────────────────╮
│                   Stored Secrets                     │
├────┬─────────────┬─────────┬──────────────────────┤
│ ID │ Name        │ Type    │ Created At           │
├────┼─────────────┼─────────┼──────────────────────┤
│ 1  │ openai-prod │ openai  │ 2025-01-22 10:00:00 │
│ 2  │ keboola-prod│ keboola │ 2025-01-22 10:01:00 │
╰────┴─────────────┴─────────┴──────────────────────╯
```

### Delete a secret
```bash
# With confirmation
python teckochecker.py secret delete openai-test
Are you sure you want to delete secret 'openai-test'? [y/N]: y

# Without confirmation
python teckochecker.py secret delete openai-test --force
```

## Managing Polling Jobs

### Create a new job
```bash
python teckochecker.py job create \
  --name "Batch processing job" \
  --batch-id "batch_abc123" \
  --openai-secret "openai-prod" \
  --keboola-secret "keboola-prod" \
  --keboola-stack "https://connection.eu-central-1.keboola.com" \
  --component-id "kds-team.app-custom-python" \
  --config-id "123456" \
  --poll-interval 120  # Check every 2 minutes

✓ Polling job 'Batch processing job' created successfully (ID: 1)
```

### Creating Multi-Batch Jobs (v1.0+)

TeckoChecker supports monitoring multiple OpenAI batch jobs in a single polling job. This is useful when you need to wait for multiple batch processing operations to complete before triggering downstream workflows.

#### Via CLI:
```bash
teckochecker job create \
  --name "Multi-batch processing" \
  --batch-id "batch_abc123" \
  --batch-id "batch_def456" \
  --batch-id "batch_ghi789" \
  --openai-secret "openai-prod" \
  --keboola-secret "keboola-prod" \
  --keboola-stack "https://connection.eu-central-1.keboola.com" \
  --component-id "kds-team.app-custom-python" \
  --config-id "123456" \
  --poll-interval 120
```

#### Via API:
```json
POST /api/jobs
{
  "name": "Process multiple batches",
  "batch_ids": [
    "batch_abc123",
    "batch_def456",
    "batch_ghi789"
  ],
  "openai_secret_id": 1,
  "keboola_secret_id": 2,
  "keboola_stack_url": "https://connection.eu-central-1.keboola.com",
  "keboola_component_id": "kds-team.app-custom-python",
  "keboola_configuration_id": "123456",
  "poll_interval_seconds": 120
}
```

**Key Features:**
- Monitor 1-10 batch IDs per job
- Keboola triggered when ALL batches complete (or reach terminal state)
- Batch completion metadata automatically passed to Keboola jobs
- Individual batch status tracking and progress reporting

### Multi-Batch Completion Logic

**Trigger Condition:**
- The job triggers Keboola when ALL batches reach a terminal state
- Terminal states: `completed`, `failed`, `cancelled`, `expired`
- Failed or cancelled batches don't block the trigger - the job completes and passes failure info to Keboola

**Metadata Passed to Keboola:**
When a multi-batch job completes, the following metadata is automatically sent to your Keboola configuration:
- `batch_ids_completed`: List of successfully completed batch IDs
- `batch_ids_failed`: List of failed/cancelled/expired batch IDs
- `batch_count_total`: Total number of batches monitored
- `batch_count_completed`: Count of successfully completed batches
- `batch_count_failed`: Count of failed batches

**Example Scenario:**
- Job monitors 5 batches
- 3 complete successfully
- 2 fail due to OpenAI errors
- Result: Job status = `completed_with_failures`
- Keboola receives both lists and can handle partial success scenarios

### Parameters for job creation
- `--name`: Descriptive job name
- `--batch-id`: OpenAI batch job ID (can be specified multiple times for multi-batch jobs)
- `--openai-secret`: OpenAI secret name
- `--keboola-secret`: Keboola secret name
- `--keboola-stack`: Keboola stack URL (e.g., `https://connection.eu-central-1.keboola.com`)
- `--component-id`: Keboola component ID (e.g., `kds-team.app-custom-python`)
- `--config-id`: Configuration ID in Keboola
- `--poll-interval`: Check interval in seconds (30-3600)

### List jobs
```bash
# All jobs
python teckochecker.py job list

# Only active jobs
python teckochecker.py job list --status active

# Only completed jobs
python teckochecker.py job list --status completed
```

### Monitoring Multi-Batch Job Progress

#### Via CLI:
```bash
# List jobs with batch completion ratios
teckochecker job list
# Output shows: Job "Multi-batch processing" → Batches: 3/5 completed

# View detailed batch status
teckochecker job show <job-id>
# Shows individual batch statuses and timestamps
```

**Example CLI output for multi-batch job:**
```bash
╭─────────────────────────────────────────────────────╮
│              Polling Job Details                    │
├─────────────────┬───────────────────────────────────┤
│ ID              │ 1                                 │
│ Name            │ Multi-batch processing           │
│ Status          │ 🟢 active                        │
│ Batches         │ 3/5 completed                     │
│ Poll Interval   │ 120 seconds                       │
│ Last Check      │ 2025-01-22 10:15:00              │
│ Next Check      │ 2025-01-22 10:17:00              │
│ Created At      │ 2025-01-22 10:00:00              │
├─────────────────┴───────────────────────────────────┤
│                  Batch Status                       │
├────────────────────────────┬────────────────────────┤
│ batch_abc123               │ ✓ completed            │
│ batch_def456               │ ✓ completed            │
│ batch_ghi789               │ ✓ completed            │
│ batch_jkl012               │ ⏳ in_progress         │
│ batch_mno345               │ 🔄 validating          │
╰────────────────────────────┴────────────────────────╯
```

#### Via Web UI:
- Job list displays completion badges (e.g., "3/5 completed")
- Click job row to see detailed batch status table
- Color-coded status indicators:
  - Green: completed batches
  - Red: failed/cancelled/expired batches
  - Yellow: in-progress batches
  - Blue: validating/queued batches

### Job details
```bash
python teckochecker.py job show 1

╭─────────────────────────────────────────────────────╮
│              Polling Job Details                    │
├─────────────────┬───────────────────────────────────┤
│ ID              │ 1                                 │
│ Name            │ Batch processing job             │
│ Status          │ 🟢 active                        │
│ Batch ID        │ batch_abc123                      │
│ Poll Interval   │ 120 seconds                       │
│ Last Check      │ 2025-01-22 10:15:00              │
│ Next Check      │ 2025-01-22 10:17:00              │
│ Created At      │ 2025-01-22 10:00:00              │
╰─────────────────┴───────────────────────────────────╯
```

### Managing job state
```bash
# Pause job
python teckochecker.py job pause 1
✓ Job 'Batch processing job' has been paused

# Resume job
python teckochecker.py job resume 1
✓ Job 'Batch processing job' has been resumed

# Delete job
python teckochecker.py job delete 1 --force
✓ Job deleted successfully
```

## Running Polling Service

### Start API server
```bash
# Start API server (polling service starts automatically)
source venv/bin/activate
python teckochecker.py start --reload

# Server will run on http://127.0.0.1:8000
# Swagger documentation: http://127.0.0.1:8000/docs
# ReDoc documentation: http://127.0.0.1:8000/redoc

# Or run as daemon in background
python teckochecker.py start --daemon
```

Note: The polling service starts automatically with the API server, so you don't need to start it separately.

### Check status
```bash
python teckochecker.py status

╭─────────────────────────────────────────────────────╮
│              System Status                          │
├─────────────────┬───────────────────────────────────┤
│ Service         │ 🟢 Running                       │
│ Uptime          │ 2 hours 15 minutes                │
│ Active Jobs     │ 3                                 │
│ Completed Jobs  │ 12                                │
│ Failed Jobs     │ 0                                 │
│ API Server      │ http://0.0.0.0:8000              │
│ Database        │ Connected                         │
╰─────────────────┴───────────────────────────────────╯
```

### Stop service
```bash
python teckochecker.py stop
✓ TeckoChecker daemon stopped
```

## REST API

API runs on `http://localhost:8000` when the service is running.

### Swagger documentation
Visit `http://localhost:8000/docs` for interactive API documentation.

### Main endpoints

#### Health Check
```bash
curl http://localhost:8000/api/health
```

#### Statistics
```bash
curl http://localhost:8000/api/stats
```

#### Secrets (Admin)
```bash
# List secrets
curl http://localhost:8000/api/admin/secrets

# Create secret
curl -X POST http://localhost:8000/api/admin/secrets \
  -H "Content-Type: application/json" \
  -d '{"name": "openai-test", "type": "openai", "value": "sk-..."}'

# Delete secret
curl -X DELETE http://localhost:8000/api/admin/secrets/1
```

#### Polling Jobs
```bash
# List jobs
curl http://localhost:8000/api/jobs

# Job details
curl http://localhost:8000/api/jobs/1

# Create job (single batch)
curl -X POST http://localhost:8000/api/jobs \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test job",
    "batch_ids": ["batch_123"],
    "openai_secret_id": 1,
    "keboola_secret_id": 2,
    "keboola_stack_url": "https://connection.eu-central-1.keboola.com",
    "keboola_component_id": "kds-team.app-custom-python",
    "keboola_configuration_id": "123456",
    "poll_interval_seconds": 120
  }'

# Create multi-batch job
curl -X POST http://localhost:8000/api/jobs \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Multi-batch job",
    "batch_ids": ["batch_abc123", "batch_def456", "batch_ghi789"],
    "openai_secret_id": 1,
    "keboola_secret_id": 2,
    "keboola_stack_url": "https://connection.eu-central-1.keboola.com",
    "keboola_component_id": "kds-team.app-custom-python",
    "keboola_configuration_id": "123456",
    "poll_interval_seconds": 120
  }'

# Pause job
curl -X POST http://localhost:8000/api/jobs/1/pause

# Resume job
curl -X POST http://localhost:8000/api/jobs/1/resume
```

## Troubleshooting

### Database

**Problem**: Database initialization error
```bash
# Reset database (WARNING: deletes all data!)
python scripts/init_db.py --reset

# Check schema
python scripts/show_schema.py
```

**Problem**: SQLite locked error
- Make sure only one instance of the application is running
- Restart the application

### Secrets

**Problem**: "Secret not found" error
```bash
# Check existing secrets
python teckochecker.py secret list

# Add missing secret
python teckochecker.py secret add --name "name" --type "type"
```

**Problem**: Encryption error
- Check that you have SECRET_KEY set in .env
- SECRET_KEY must be the same as when secrets were created
- SECRET_KEY must be a valid Fernet key (44 characters, base64-encoded)
- If you need to regenerate SECRET_KEY:
  ```bash
  python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"
  ```
  **Warning:** Regenerating SECRET_KEY will make all existing secrets unreadable!

### Polling

**Problem**: Job is not starting
```bash
# Check job status
python teckochecker.py job show JOB_ID

# Check if polling service is running
python teckochecker.py status

# Check logs (if configured)
tail -f teckochecker.log
```

**Problem**: OpenAI API errors
- Verify API key validity
- Check rate limits
- Verify batch_id correctness

**Problem**: Keboola API errors
- Verify Storage API token validity
- Check stack URL correctness
- Verify configuration ID

### Multi-Batch Validation Errors

**Error**: "At least one batch ID is required"
- **Cause**: No `--batch-id` flags provided when creating a job
- **Solution**: Add at least one `--batch-id` flag to your command

**Error**: "Too many batch IDs: X (maximum: 10)"
- **Cause**: More than 10 batch IDs provided
- **Solution**: Split into multiple jobs or reduce the number of batches to 10 or fewer

**Error**: "Duplicate batch IDs found. Each batch ID must be unique."
- **Cause**: Same batch ID specified multiple times
- **Solution**: Remove duplicate batch IDs from your command

**Error**: "Invalid batch ID format: 'XXX' (must start with 'batch_')"
- **Cause**: Batch ID doesn't start with required 'batch_' prefix
- **Solution**: Ensure all batch IDs start with 'batch_' (e.g., 'batch_abc123')

**Error**: "Batch ID 'XXX' contains invalid characters"
- **Cause**: Batch ID contains characters outside allowed set [a-zA-Z0-9_-]
- **Solution**: Use only alphanumeric characters, underscores, and hyphens
- **Examples**:
  - ✅ Valid: `batch_abc123`, `batch_test-job_01`, `batch_2024-10-23_ABC`
  - ❌ Invalid: `batch_test@job`, `batch_test job`, `batch_test.job`, `batch_tëst`

**Error**: "Batch ID 'XXX' exceeds 255 character limit"
- **Cause**: Batch ID is too long
- **Solution**: Verify the batch ID from OpenAI API (OpenAI batch IDs should not exceed this limit)

**Error**: "Batch ID 'XXX' too short (must have content after 'batch_')"
- **Cause**: Batch ID is just 'batch_' with no content after
- **Solution**: Ensure batch ID has characters after the 'batch_' prefix (e.g., 'batch_1', 'batch_abc')

**Common Validation Scenarios:**

```bash
# ❌ Error: No batch IDs
teckochecker job create --name "Test" --openai-secret "test" ...
# Fix: Add at least one --batch-id

# ❌ Error: Too many batches
teckochecker job create --batch-id "batch_1" ... --batch-id "batch_11" ...
# Fix: Maximum 10 batches allowed

# ❌ Error: Duplicates
teckochecker job create --batch-id "batch_123" --batch-id "batch_123" ...
# Fix: Remove duplicate batch IDs

# ❌ Error: Invalid format
teckochecker job create --batch-id "abc123" ...
# Fix: Use --batch-id "batch_abc123"

# ✅ Correct: Single batch
teckochecker job create --batch-id "batch_abc123" ...

# ✅ Correct: Multiple batches
teckochecker job create --batch-id "batch_1" --batch-id "batch_2" --batch-id "batch_3" ...
```

### General

**Problem**: Command not found
```bash
# Make sure you're in the correct directory
cd /path/to/teckochecker

# Activate virtual environment
source venv/bin/activate

# Use direct execution
python teckochecker.py --help
```

**Problem**: Permission denied
```bash
# Set correct permissions
chmod +x teckochecker.py
chmod +x scripts/*.py
```

## Advanced Usage

### Custom polling intervals
Each job can have its own interval:
- Minimum: 30 seconds
- Maximum: 3600 seconds (1 hour)
- Recommended: 60-300 seconds

### Migration to PostgreSQL
For production deployment:
1. Install PostgreSQL
2. Create database
3. Edit DATABASE_URL in .env:
   ```
   DATABASE_URL=postgresql://user:password@localhost/teckochecker
   ```
4. Run initialization: `python scripts/init_db.py`

### Docker deployment
```bash
# Build image
docker build -t teckochecker .

# Run container
docker run -d \
  -p 8000:8000 \
  -v $(pwd)/teckochecker.db:/app/teckochecker.db \
  -v $(pwd)/.env:/app/.env \
  teckochecker
```

### Systemd service
For automatic startup on Linux server, create `/etc/systemd/system/teckochecker.service`:
```ini
[Unit]
Description=TeckoChecker Polling Service
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/opt/teckochecker
Environment=PATH=/opt/teckochecker/venv/bin
ExecStart=/opt/teckochecker/venv/bin/python /opt/teckochecker/teckochecker.py start
Restart=always

[Install]
WantedBy=multi-user.target
```

## Support

For bug reports or feature suggestions, use GitHub Issues.